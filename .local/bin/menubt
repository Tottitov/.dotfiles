#!/bin/sh

toggle() {
	notify-send -r 5 "$device" "Attempting to $1"

	(bluetoothctl "$1" "$mac" &&
		notify-send -r 5 "$device" "Successfully ${1}ed") ||
		notify-send -r 5 -u critical "$device" "Failed to $1"
}

bluetoothctl show | rg -q "Powered: no" && {
	notify-send -r 5 "Bluetooth not powered on"
	exit 1
}

devices=$(bluetoothctl devices)
connected=$(bluetoothctl devices Connected)

deviceCount=$(echo "$devices" | wc -l)
if [ "$deviceCount" -gt 1 ]; then
	choice=$(
		echo "$devices" | cut -d' ' -f3 | sort |
			fuzzel \
				--placeholder="$(echo "$connected" | cut -d' ' -f3)" \
				-l "$deviceCount" -w 20 -di
	) || exit 0
	device="$choice"
	mac=$(echo "$devices" | rg "${choice}$" | cut -d' ' -f2)
elif [ "$deviceCount" -eq 1 ]; then
	device=$(echo "$devices" | cut -d' ' -f3)
	mac=$(echo "$devices" | cut -d' ' -f2)
else
	notify-send "Bluetooth" "No saved devices"
	exit 1
fi

(echo "$connected" | rg -q "$mac" && toggle disconnect) || toggle connect
