#!/bin/sh

interval() { echo "$1" | tofi --prompt "${2}: "; }

dates=""
for i in $(seq 0 30); do
    dates="$dates\n$(date -d "+$i days" +'%m/%d/%Y')"
done

times=""
for hour in $(seq 1 12); do
    for minute in 00 15 30 45; do
        times="$times\n${hour}:${minute}"
    done
done

event=$(echo "" | tofi --require-match=false --prompt "Event: ") || exit 1
startdate=$(interval "$dates" "Start Date") || exit 1
enddate=$(interval "$dates" "End Date") || exit 1
startmer=$(printf "AM\nPM" | tofi --prompt "Start Meridiem: ") || exit 1
endmer=$(printf "AM\nPM" | tofi --prompt "End Meridiem: ") || exit 1
starttime=$(interval "$times" "Start Time") || exit 1
endtime=$(interval "$times" "End Time") || exit 1

(khal new \
    "$startdate" \
    "$starttime $startmer" \
    "$enddate" \
    "$endtime $endmer" \
    "$event" && vdirsyncer sync >/dev/null 2>&1) ||
    notify-send -u critical "Failed to add event"
