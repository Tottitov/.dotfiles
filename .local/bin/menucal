#!/bin/sh

menu() { fuzzel -dip "$1"; }

dates=""
for i in $(seq 0 30); do
    current="$(date -d "+${i} days" +'%m/%d/%Y %a')"
    [ "$i" -eq 0 ] && dates="${dates}\n${current}" ||
        dates="${dates}\n${current} (+${i})"
done

times=""
for hour in $(seq 1 12); do
    for minute in 00 15 30 45; do
        times="${times}\n${hour}:${minute} AM"
        times="${times}\n${hour}:${minute} PM"
    done
done

event=$(fuzzel -dil 0 -w 100 -p "Calendar Event: ") || exit 1

startdate=$(menu "$dates" "Start Date") || exit 1
enddate=$(menu "$dates" "End Date") || exit 1
startdate=$(echo "$startdate" | cut -d ' ' -f 1)
enddate=$(echo "$enddate" | cut -d ' ' -f 1)

starttime=$(menu "$times" "Start Time")
endtime=$(menu "$times" "End Time")

[ -z "$starttime" ] && [ -z "$endtime" ] &&
    args="$startdate $enddate $event" ||
    args="$startdate $starttime $enddate $endtime $event"

(khal new "$args" && vdirsyncer sync >/dev/null 2>&1 &&
    notify-send "$event" "Published successfully") ||
    notify-send -u critical "$event" "Publish unsuccessful"
