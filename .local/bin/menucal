#!/bin/sh

menu() { fuzzel -dip "$1"; }

dates="$(date +'%m/%d/%Y %a')"
for i in $(seq 1 30); do
    current="$(date -d "+${i} days" +'%m/%d/%Y %a')"
    dates="${dates}\n${current} (+${i})"
done

times="1:00 AM\n1:00 PM"
for hour in $(seq 1 12); do
    for minute in 00 15 30 45; do
        [ "$hour" -eq 1 ] && [ "$minute" -eq 00 ] && continue
        times="${times}\n${hour}:${minute} AM"
        times="${times}\n${hour}:${minute} PM"
    done
done

event=$(fuzzel -dil 0 -w 100 -p "Calendar Event: ") || exit 1

startdate=$(echo "$dates" | menu "Start Date: ") || exit 1
enddate=$(echo "$dates" | menu "End Date: ") || exit 1
startdate=$(echo "$startdate" | cut -d ' ' -f 1)
enddate=$(echo "$enddate" | cut -d ' ' -f 1)

starttime=$(echo "$times" | menu "Start Time: ")
endtime=$(echo "$times" | menu "End Time: ")

[ -z "$starttime" ] && [ -z "$endtime" ] &&
    args="$startdate $enddate $event" ||
    args="$startdate $starttime $enddate $endtime $event"

(khal new "$args" && vdirsyncer sync >/dev/null 2>&1 &&
    notify-send "$event" "Published successfully") ||
    notify-send -u critical "$event" "Publish unsuccessful"
